Попытался описать все непонятные моменты в комментах